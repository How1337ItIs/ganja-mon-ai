<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grok & Mon - Local Dashboard</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --text: #ffffff;
            --text-dim: #888;
            --green: #4ade80;
            --red: #f87171;
            --yellow: #fbbf24;
            --purple: #a78bfa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--red);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
        }

        .card-header {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric {
            font-size: 48px;
            font-weight: bold;
            line-height: 1;
        }

        .metric-unit {
            font-size: 20px;
            color: var(--text-dim);
            margin-left: 5px;
        }

        .metric-status {
            margin-top: 10px;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .metric-status.good {
            background: rgba(74, 222, 128, 0.2);
            color: var(--green);
        }

        .metric-status.warning {
            background: rgba(251, 191, 36, 0.2);
            color: var(--yellow);
        }

        .metric-status.bad {
            background: rgba(248, 113, 113, 0.2);
            color: var(--red);
        }

        .devices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .device {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .device-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
        }

        .device-indicator.on {
            background: var(--green);
            box-shadow: 0 0 10px var(--green);
        }

        .device-name {
            font-size: 14px;
        }

        .ai-output {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .ai-text {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-dim);
        }

        .webcam-container {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .webcam-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            font-size: 14px;
            color: var(--text-dim);
        }

        .webcam-image {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
        }

        .webcam-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
            font-size: 12px;
        }

        .refresh-btn {
            background: var(--purple);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        .grow-day {
            font-size: 14px;
            color: var(--purple);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ðŸŒ¿ Grok & Mon</h1>
                <div class="grow-day">Day <span id="grow-day">1</span> Â· <span id="growth-stage">SEEDLING</span></div>
            </div>
            <div class="status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Connecting...</span>
                <button class="refresh-btn" onclick="refreshData()">Refresh</button>
            </div>
        </header>

        <div class="grid">
            <div class="card">
                <div class="card-header">Temperature</div>
                <div class="metric">
                    <span id="temp">--</span>
                    <span class="metric-unit">Â°F</span>
                </div>
                <div class="metric-status" id="temp-status">Loading...</div>
            </div>

            <div class="card">
                <div class="card-header">Humidity</div>
                <div class="metric">
                    <span id="humidity">--</span>
                    <span class="metric-unit">%</span>
                </div>
                <div class="metric-status" id="humidity-status">Loading...</div>
            </div>

            <div class="card">
                <div class="card-header">VPD</div>
                <div class="metric">
                    <span id="vpd">--</span>
                    <span class="metric-unit">kPa</span>
                </div>
                <div class="metric-status" id="vpd-status">Loading...</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">Devices</div>
            <div class="devices">
                <div class="device">
                    <div class="device-indicator" id="light-indicator"></div>
                    <span class="device-name">Grow Light</span>
                </div>
                <div class="device">
                    <div class="device-indicator" id="exhaust-indicator"></div>
                    <span class="device-name">Exhaust Fan</span>
                </div>
                <div class="device">
                    <div class="device-indicator" id="circ-indicator"></div>
                    <span class="device-name">Circulation Fan</span>
                </div>
                <div class="device">
                    <div class="device-indicator" id="pump-indicator"></div>
                    <span class="device-name">Water Pump</span>
                </div>
            </div>
        </div>

        <div class="ai-output">
            <div class="ai-header">
                <span>ðŸ¤–</span>
                <span>Grok AI Output</span>
            </div>
            <div class="ai-text" id="ai-output">Waiting for first decision cycle...</div>
        </div>

        <div class="webcam-container">
            <div class="webcam-header">ðŸ“· Live Webcam</div>
            <img class="webcam-image" id="webcam" src="" alt="Webcam feed" style="display: none;">
            <div class="webcam-placeholder" id="webcam-placeholder">Webcam not connected</div>
        </div>

        <div class="footer">
            Last updated: <span id="last-update">Never</span>
        </div>
    </div>

    <script>
        // Configuration - edit these for your setup
        const API_BASE = 'http://localhost:8000';
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // VPD targets by stage
        const VPD_TARGETS = {
            'SEEDLING': { min: 0.4, max: 0.8 },
            'VEGETATIVE': { min: 0.8, max: 1.2 },
            'FLOWERING': { min: 1.0, max: 1.5 },
        };

        // Temperature targets (Fahrenheit)
        const TEMP_TARGETS = { min: 70, max: 82 };

        // Humidity targets
        const HUMIDITY_TARGETS = { min: 50, max: 70 };

        let currentStage = 'SEEDLING';

        function getStatus(value, targets) {
            if (value >= targets.min && value <= targets.max) {
                return { class: 'good', text: 'Optimal' };
            } else if (value < targets.min * 0.9 || value > targets.max * 1.1) {
                return { class: 'bad', text: value < targets.min ? 'Too Low' : 'Too High' };
            } else {
                return { class: 'warning', text: 'Borderline' };
            }
        }

        async function fetchSensors() {
            try {
                const response = await fetch(`${API_BASE}/api/sensors/live`);
                if (!response.ok) throw new Error('API error');
                return await response.json();
            } catch (e) {
                console.error('Failed to fetch sensors:', e);
                return null;
            }
        }

        async function fetchDevices() {
            try {
                const response = await fetch(`${API_BASE}/api/devices/latest`);
                if (!response.ok) throw new Error('API error');
                return await response.json();
            } catch (e) {
                console.error('Failed to fetch devices:', e);
                return null;
            }
        }

        async function fetchAI() {
            try {
                const response = await fetch(`${API_BASE}/api/ai/latest`);
                if (!response.ok) throw new Error('API error');
                return await response.json();
            } catch (e) {
                console.error('Failed to fetch AI:', e);
                return null;
            }
        }

        async function fetchGrowStage() {
            try {
                const response = await fetch(`${API_BASE}/api/grow/stage`);
                if (!response.ok) throw new Error('API error');
                return await response.json();
            } catch (e) {
                console.error('Failed to fetch grow stage:', e);
                return null;
            }
        }

        function updateWebcam() {
            const img = document.getElementById('webcam');
            const placeholder = document.getElementById('webcam-placeholder');

            const newImg = new Image();
            newImg.onload = () => {
                img.src = newImg.src;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            };
            newImg.onerror = () => {
                img.style.display = 'none';
                placeholder.style.display = 'flex';
            };
            // Add timestamp to bust cache
            newImg.src = `${API_BASE}/api/webcam/latest?t=${Date.now()}`;
        }

        async function refreshData() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            try {
                // Fetch all data
                const [sensors, devices, ai, stage] = await Promise.all([
                    fetchSensors(),
                    fetchDevices(),
                    fetchAI(),
                    fetchGrowStage(),
                ]);

                // Update grow stage
                if (stage) {
                    currentStage = stage.current_stage?.toUpperCase() || 'SEEDLING';
                    document.getElementById('grow-day').textContent = stage.current_day || 1;
                    document.getElementById('growth-stage').textContent = currentStage;
                }

                // Update sensors
                if (sensors) {
                    // Temperature
                    const temp = sensors.temperature_f || (sensors.air_temp * 9/5 + 32);
                    document.getElementById('temp').textContent = temp.toFixed(1);
                    const tempStatus = getStatus(temp, TEMP_TARGETS);
                    const tempEl = document.getElementById('temp-status');
                    tempEl.textContent = tempStatus.text;
                    tempEl.className = `metric-status ${tempStatus.class}`;

                    // Humidity
                    const humidity = sensors.humidity_percent || sensors.humidity;
                    document.getElementById('humidity').textContent = humidity.toFixed(0);
                    const humidityStatus = getStatus(humidity, HUMIDITY_TARGETS);
                    const humidityEl = document.getElementById('humidity-status');
                    humidityEl.textContent = humidityStatus.text;
                    humidityEl.className = `metric-status ${humidityStatus.class}`;

                    // VPD
                    const vpd = sensors.vpd_kpa || sensors.vpd;
                    document.getElementById('vpd').textContent = vpd.toFixed(2);
                    const vpdTargets = VPD_TARGETS[currentStage] || VPD_TARGETS.VEGETATIVE;
                    const vpdStatus = getStatus(vpd, vpdTargets);
                    const vpdEl = document.getElementById('vpd-status');
                    vpdEl.textContent = vpdStatus.text;
                    vpdEl.className = `metric-status ${vpdStatus.class}`;
                }

                // Update devices
                if (devices) {
                    updateDevice('light-indicator', devices.grow_light);
                    updateDevice('exhaust-indicator', devices.exhaust_fan);
                    updateDevice('circ-indicator', devices.circulation_fan);
                    updateDevice('pump-indicator', devices.water_pump);
                }

                // Update AI output
                if (ai && ai.output_text) {
                    document.getElementById('ai-output').textContent = ai.output_text;
                }

                // Update webcam
                updateWebcam();

                // Update status
                statusDot.className = 'status-dot';
                statusText.textContent = 'Connected';

                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            } catch (e) {
                console.error('Refresh failed:', e);
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'Offline';
            }
        }

        function updateDevice(elementId, isOn) {
            const el = document.getElementById(elementId);
            if (isOn) {
                el.classList.add('on');
            } else {
                el.classList.remove('on');
            }
        }

        // Initial load
        refreshData();

        // Auto-refresh
        setInterval(refreshData, REFRESH_INTERVAL);
    </script>
</body>
</html>
