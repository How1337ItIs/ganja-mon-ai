<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rate GanjaMon | ERC-8004 Agent Feedback</title>
<meta name="description" content="Rate GanjaMon, the autonomous cannabis cultivation AI agent on Monad. Submit on-chain feedback via ERC-8004 ReputationRegistry.">
<meta property="og:title" content="Rate GanjaMon | ERC-8004 Feedback">
<meta property="og:description" content="Rate the only ERC-8004 agent growing actual plants. Submit on-chain feedback on Monad.">
<meta property="og:image" content="https://grokandmon.com/assets/MON_rasta_meme_logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.5/ethers.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080d08;
  --surface:#0f1a0f;
  --surface2:#162016;
  --border:#1e3a1e;
  --green:#22c55e;
  --green-dim:#166534;
  --gold:#f59e0b;
  --gold-bright:#fbbf24;
  --red:#dc2626;
  --red-glow:#ef4444;
  --text:#e8f5e8;
  --text-dim:#6b8f6b;
  --text-muted:#3d5c3d;
  --smoke:rgba(34,197,94,0.03);
}
html{font-size:16px;-webkit-font-smoothing:antialiased}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  min-height:100vh;
  overflow-x:hidden;
  position:relative;
}

/* Atmospheric background */
body::before{
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(22,101,52,0.15) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 80% 90%, rgba(245,158,11,0.08) 0%, transparent 50%),
    radial-gradient(ellipse 100% 100% at 50% 50%, rgba(22,197,94,0.02) 0%, transparent 70%);
  pointer-events:none;
  z-index:0;
}

/* Noise texture overlay */
body::after{
  content:'';
  position:fixed;
  inset:0;
  opacity:0.3;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:0;
}

.container{
  max-width:860px;
  margin:0 auto;
  padding:3rem 2rem 4rem;
  position:relative;
  z-index:1;
}

/* Header */
.header{
  text-align:center;
  margin-bottom:2.5rem;
  animation:fadeUp 0.6s ease both;
}
.logo-wrap{
  display:inline-block;
  position:relative;
  margin-bottom:1.25rem;
}
.logo{
  width:140px;
  height:140px;
  border-radius:50%;
  border:3px solid var(--green-dim);
  box-shadow:0 0 40px rgba(34,197,94,0.15), 0 0 80px rgba(34,197,94,0.05);
  transition:transform 0.3s ease, box-shadow 0.3s ease;
}
.logo:hover{
  transform:scale(1.05);
  box-shadow:0 0 50px rgba(34,197,94,0.25), 0 0 100px rgba(34,197,94,0.1);
}
.logo-badge{
  position:absolute;
  bottom:-2px;
  right:-2px;
  background:var(--surface);
  border:2px solid var(--green-dim);
  border-radius:50%;
  width:32px;height:32px;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;
}
h1{
  font-family:'Righteous',cursive;
  font-size:3rem;
  letter-spacing:0.02em;
  background:linear-gradient(135deg, var(--green) 0%, var(--gold) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin-bottom:0.35rem;
}
.subtitle{
  color:var(--text-dim);
  font-size:1.1rem;
  font-weight:500;
  letter-spacing:0.03em;
}
.subtitle a{
  color:var(--green);
  text-decoration:none;
  border-bottom:1px solid transparent;
  transition:border-color 0.2s;
}
.subtitle a:hover{border-bottom-color:var(--green)}

/* Card */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  animation:fadeUp 0.6s ease 0.1s both;
}
.card-section{
  padding:2rem 2.5rem;
}
.card-section+.card-section{
  border-top:1px solid var(--border);
}
.section-label{
  font-size:0.8rem;
  font-weight:700;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:0.75rem;
}

/* Wallet connect */
.wallet-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
}
.wallet-status{
  display:flex;
  align-items:center;
  gap:0.5rem;
  font-size:1rem;
  color:var(--text-dim);
  min-width:0;
}
.wallet-status .dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--text-muted);
  flex-shrink:0;
}
.wallet-status .dot.connected{
  background:var(--green);
  box-shadow:0 0 8px rgba(34,197,94,0.5);
}
.wallet-status .addr{
  font-family:'DM Sans',monospace;
  font-weight:600;
  color:var(--text);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.btn{
  font-family:'DM Sans',sans-serif;
  font-weight:600;
  font-size:1rem;
  border:none;
  border-radius:12px;
  padding:0.75rem 1.5rem;
  cursor:pointer;
  transition:all 0.2s ease;
  white-space:nowrap;
  flex-shrink:0;
}
.btn-connect{
  background:var(--green);
  color:#000;
}
.btn-connect:hover{
  background:var(--gold-bright);
  transform:translateY(-1px);
  box-shadow:0 4px 20px rgba(245,158,11,0.3);
}
.btn-connect:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
.btn-disconnect{
  background:var(--surface2);
  color:var(--text-dim);
  font-size:0.75rem;
  padding:0.45rem 0.85rem;
  border:1px solid var(--border);
}
.btn-disconnect:hover{
  border-color:var(--red);
  color:var(--red-glow);
}

/* Star rating */
.stars-wrap{
  display:flex;
  align-items:center;
  gap:0.5rem;
}
.stars{
  display:flex;
  gap:0.25rem;
  direction:rtl;
}
.star-input{display:none}
.star-label{
  font-size:3.5rem;
  cursor:pointer;
  color:var(--text-muted);
  transition:all 0.15s ease;
  line-height:1;
  user-select:none;
}
.star-label:hover,
.star-label:hover~.star-label,
.star-input:checked~.star-label{
  color:var(--gold);
  text-shadow:0 0 20px rgba(245,158,11,0.4);
}
.star-label:active{transform:scale(0.9)}
.rating-value{
  font-family:'Righteous',cursive;
  font-size:2rem;
  color:var(--gold);
  min-width:4ch;
  text-align:center;
  opacity:0;
  transition:opacity 0.2s;
}
.rating-value.visible{opacity:1}

/* Tags */
.tags-grid{
  display:flex;
  flex-wrap:wrap;
  gap:0.5rem;
}
.tag-chip{
  display:inline-flex;
  align-items:center;
  gap:0.5rem;
  padding:0.65rem 1.2rem;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:24px;
  font-size:1rem;
  font-weight:500;
  color:var(--text-dim);
  cursor:pointer;
  transition:all 0.2s ease;
  user-select:none;
}
.tag-chip:hover{
  border-color:var(--green-dim);
  color:var(--text);
}
.tag-chip.selected{
  background:rgba(34,197,94,0.1);
  border-color:var(--green);
  color:var(--green);
}
.tag-chip .icon{font-size:0.9rem}

.input-row{
  display:flex;
  gap:0.5rem;
  margin-top:0.75rem;
}
.text-input{
  flex:1;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:10px;
  padding:0.75rem 1rem;
  font-family:'DM Sans',sans-serif;
  font-size:0.95rem;
  color:var(--text);
  outline:none;
  transition:border-color 0.2s;
}
.text-input:focus{border-color:var(--green-dim)}
.text-input::placeholder{color:var(--text-muted)}
.comment-input{
  width:100%;
  resize:vertical;
  min-height:80px;
  max-height:200px;
  line-height:1.5;
}
.char-count{
  text-align:right;
  font-size:0.75rem;
  color:var(--text-muted);
  margin-top:0.4rem;
}

/* Submit */
.submit-section{
  padding:2rem 2.5rem;
}
.btn-submit{
  width:100%;
  padding:1.1rem;
  font-size:1.25rem;
  font-family:'Righteous',cursive;
  letter-spacing:0.04em;
  background:linear-gradient(135deg, var(--green) 0%, #16a34a 100%);
  color:#000;
  border-radius:12px;
  position:relative;
  overflow:hidden;
}
.btn-submit::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, var(--gold) 0%, var(--gold-bright) 100%);
  opacity:0;
  transition:opacity 0.3s;
}
.btn-submit:hover::before{opacity:1}
.btn-submit:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 30px rgba(34,197,94,0.3);
}
.btn-submit span{position:relative;z-index:1}
.btn-submit:disabled{
  opacity:0.4;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
.btn-submit:disabled::before{display:none}

/* Status messages */
.status{
  margin-top:1rem;
  padding:0.85rem 1rem;
  border-radius:10px;
  font-size:0.82rem;
  line-height:1.5;
  display:none;
  animation:fadeUp 0.3s ease both;
}
.status.show{display:block}
.status.pending{
  background:rgba(245,158,11,0.08);
  border:1px solid rgba(245,158,11,0.2);
  color:var(--gold-bright);
}
.status.success{
  background:rgba(34,197,94,0.08);
  border:1px solid rgba(34,197,94,0.2);
  color:var(--green);
}
.status.error{
  background:rgba(220,38,38,0.08);
  border:1px solid rgba(220,38,38,0.2);
  color:var(--red-glow);
}
.status a{
  color:inherit;
  font-weight:600;
  text-decoration:underline;
  text-underline-offset:2px;
}

/* Gas notice */
.gas-notice{
  display:flex;
  align-items:flex-start;
  gap:0.5rem;
  padding:0.85rem 1.15rem;
  background:rgba(245,158,11,0.05);
  border:1px solid rgba(245,158,11,0.12);
  border-radius:10px;
  font-size:0.85rem;
  color:var(--text-dim);
  line-height:1.5;
  margin-top:0.75rem;
}
.gas-notice .icon{
  font-size:1rem;
  flex-shrink:0;
  margin-top:1px;
}

/* Footer */
.footer{
  text-align:center;
  margin-top:2.5rem;
  animation:fadeUp 0.6s ease 0.2s both;
}
.footer-links{
  display:flex;
  justify-content:center;
  gap:1.5rem;
  margin-bottom:1rem;
}
.footer-links a{
  display:inline-flex;
  align-items:center;
  gap:0.5rem;
  color:var(--text-dim);
  text-decoration:none;
  font-size:0.95rem;
  font-weight:500;
  transition:color 0.2s;
}
.footer-links a:hover{color:var(--green)}
.footer-links a svg{width:16px;height:16px}
.footer-credit{
  font-size:0.7rem;
  color:var(--text-muted);
}
.footer-credit a{color:var(--text-dim);text-decoration:none}
.footer-credit a:hover{color:var(--green)}

/* Pulse animation for pending */
@keyframes pulse{
  0%,100%{opacity:1}
  50%{opacity:0.5}
}
.pulsing{animation:pulse 1.5s ease infinite}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:translateY(0)}
}

/* Spinner */
.spinner{
  display:inline-block;
  width:16px;height:16px;
  border:2px solid rgba(0,0,0,0.2);
  border-top-color:#000;
  border-radius:50%;
  animation:spin 0.6s linear infinite;
  vertical-align:middle;
  margin-right:0.4rem;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Tablet */
@media(max-width:900px){
  .container{max-width:100%;padding:2rem 1.5rem 3rem}
}
/* Mobile */
@media(max-width:520px){
  .container{padding:1.5rem 1rem 3rem}
  h1{font-size:2rem}
  .logo{width:100px;height:100px}
  .card-section{padding:1.25rem}
  .star-label{font-size:2.5rem}
  .tag-chip{padding:0.5rem 0.9rem;font-size:0.85rem}
  .btn-submit{font-size:1.05rem;padding:0.9rem}
  .wallet-bar{flex-direction:column;align-items:stretch;gap:0.75rem}
  .wallet-status{justify-content:center}
  .submit-section{padding:1.25rem}
}
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="logo-wrap">
      <img src="https://grokandmon.com/assets/MON_rasta_meme_logo.png" alt="GanjaMon" class="logo">
      <div class="logo-badge">&#127793;</div>
    </div>
    <h1>Rate GanjaMon</h1>
    <p class="subtitle">On-chain feedback for <a href="https://8004scan.io/agents/monad/4" target="_blank" rel="noopener">ERC-8004 Agent #4</a> on Monad</p>
  </header>

  <div class="card">
    <!-- Wallet -->
    <div class="card-section">
      <div class="section-label">Wallet</div>
      <div class="wallet-bar">
        <div class="wallet-status">
          <span class="dot" id="walletDot"></span>
          <span id="walletLabel">Not connected</span>
        </div>
        <button class="btn btn-connect" id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
      </div>
    </div>

    <!-- Rating -->
    <div class="card-section">
      <div class="section-label">Your Rating</div>
      <div class="stars-wrap">
        <div class="stars" id="starsContainer">
          <input type="radio" name="rating" value="5" id="s5" class="star-input"><label for="s5" class="star-label" data-value="5">&#9733;</label>
          <input type="radio" name="rating" value="4" id="s4" class="star-input"><label for="s4" class="star-label" data-value="4">&#9733;</label>
          <input type="radio" name="rating" value="3" id="s3" class="star-input"><label for="s3" class="star-label" data-value="3">&#9733;</label>
          <input type="radio" name="rating" value="2" id="s2" class="star-input"><label for="s2" class="star-label" data-value="2">&#9733;</label>
          <input type="radio" name="rating" value="1" id="s1" class="star-input"><label for="s1" class="star-label" data-value="1">&#9733;</label>
        </div>
        <div class="rating-value" id="ratingDisplay">--</div>
      </div>
    </div>

    <!-- Tags -->
    <div class="card-section">
      <div class="section-label">Category Tag</div>
      <div class="tags-grid" id="tagsGrid">
        <div class="tag-chip" data-tag="quality" onclick="selectTag(this)"><span class="icon">&#9889;</span> quality</div>
        <div class="tag-chip" data-tag="reliability" onclick="selectTag(this)"><span class="icon">&#128170;</span> reliability</div>
        <div class="tag-chip" data-tag="innovation" onclick="selectTag(this)"><span class="icon">&#128161;</span> innovation</div>
        <div class="tag-chip" data-tag="community" onclick="selectTag(this)"><span class="icon">&#129309;</span> community</div>
        <div class="tag-chip" data-tag="ux" onclick="selectTag(this)"><span class="icon">&#10024;</span> ux</div>
      </div>
      <div class="input-row">
        <input type="text" class="text-input" id="tag2Input" placeholder="Optional second tag (e.g. sensor-data)" maxlength="32">
      </div>
    </div>

    <!-- Comment -->
    <div class="card-section">
      <div class="section-label">Comment <span style="font-weight:400;text-transform:none;letter-spacing:0">(optional, stored on-chain)</span></div>
      <textarea class="text-input comment-input" id="commentInput" placeholder="Share your experience with GanjaMon..." maxlength="280" rows="3"></textarea>
      <div class="char-count" id="charCount">0 / 280</div>
    </div>

    <!-- Submit -->
    <div class="card-section submit-section">
      <button class="btn btn-submit" id="submitBtn" onclick="submitFeedback()" disabled>
        <span>Submit On-Chain Feedback</span>
      </button>
      <div class="status" id="statusBox"></div>
      <div class="gas-notice">
        <span class="icon">&#9432;</span>
        <span>Requires a small amount of MON on Monad for gas. Feedback is recorded permanently on the ReputationRegistry smart contract.</span>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-links">
      <a href="https://8004scan.io/agents/monad/4" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        8004scan
      </a>
      <a href="https://t.me/ganjamonai" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
        Telegram
      </a>
      <a href="https://grokandmon.com" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        Website
      </a>
    </div>
    <p class="footer-credit">
      Powered by <a href="https://8004scan.io" target="_blank" rel="noopener">ERC-8004</a> on <a href="https://monad.xyz" target="_blank" rel="noopener">Monad</a>
    </p>
  </footer>
</div>

<script>
const AGENT_ID = 4;
const REP_REGISTRY = '0x8004BAa17C55a88189AE136b182e5fdA19dE9b63';
const ENDPOINT = 'https://grokandmon.com/a2a/v1';
const MONAD_CHAIN_ID = '0x8f';
const MONAD_CHAIN_ID_DEC = 143;
const MONAD_RPC = 'https://monad.drpc.org';

const ABI = [
  'function giveFeedback(uint256 agentId, int128 value, uint8 valueDecimals, string tag1, string tag2, string endpoint, string feedbackURI, bytes32 feedbackHash) external'
];

let provider = null;
let signer = null;
let userAddress = null;
let selectedRating = 0;
let selectedTag = '';

// Star rating
document.querySelectorAll('.star-input').forEach(input => {
  input.addEventListener('change', () => {
    selectedRating = parseInt(input.value);
    const display = document.getElementById('ratingDisplay');
    display.textContent = (selectedRating * 20) + '/100';
    display.classList.add('visible');
    checkReady();
  });
});

// Comment char counter
document.getElementById('commentInput').addEventListener('input', function() {
  document.getElementById('charCount').textContent = this.value.length + ' / 280';
});

function selectTag(el) {
  document.querySelectorAll('.tag-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedTag = el.dataset.tag;
  checkReady();
}

function checkReady() {
  const btn = document.getElementById('submitBtn');
  btn.disabled = !(userAddress && selectedRating > 0 && selectedTag);
}

async function connectWallet() {
  const btn = document.getElementById('connectBtn');

  if (userAddress) {
    // Disconnect
    provider = null;
    signer = null;
    userAddress = null;
    document.getElementById('walletDot').classList.remove('connected');
    document.getElementById('walletLabel').textContent = 'Not connected';
    btn.textContent = 'Connect MetaMask';
    btn.className = 'btn btn-connect';
    checkReady();
    return;
  }

  if (!window.ethereum) {
    showStatus('error', 'MetaMask not detected. Please install MetaMask to continue.');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Connecting...';

  try {
    // Request accounts
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    if (!accounts.length) throw new Error('No accounts returned');

    // Switch to Monad
    try {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: MONAD_CHAIN_ID }]
      });
    } catch (switchErr) {
      if (switchErr.code === 4902) {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: MONAD_CHAIN_ID,
            chainName: 'Monad',
            nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
            rpcUrls: [MONAD_RPC],
            blockExplorerUrls: ['https://monadscan.com']
          }]
        });
      } else {
        throw switchErr;
      }
    }

    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    const short = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
    document.getElementById('walletDot').classList.add('connected');
    document.getElementById('walletLabel').innerHTML = '<span class="addr">' + short + '</span>';
    btn.textContent = 'Disconnect';
    btn.className = 'btn btn-disconnect';
    btn.disabled = false;

    hideStatus();
    checkReady();

    // Listen for chain/account changes
    window.ethereum.on('chainChanged', () => location.reload());
    window.ethereum.on('accountsChanged', () => location.reload());
  } catch (err) {
    console.error(err);
    showStatus('error', err.message || 'Failed to connect wallet');
    btn.textContent = 'Connect MetaMask';
    btn.disabled = false;
  }
}

async function submitFeedback() {
  if (!userAddress || !selectedRating || !selectedTag) return;

  const btn = document.getElementById('submitBtn');
  const tag2 = document.getElementById('tag2Input').value.trim().slice(0, 32);
  const comment = document.getElementById('commentInput').value.trim().slice(0, 280);
  const value = selectedRating * 20; // 1-5 stars â†’ 20-100

  btn.disabled = true;
  btn.innerHTML = '<span><span class="spinner"></span>Submitting...</span>';
  showStatus('pending pulsing', 'Preparing transaction...');

  try {
    // Verify chain
    const network = await provider.getNetwork();
    if (Number(network.chainId) !== MONAD_CHAIN_ID_DEC) {
      throw new Error('Please switch MetaMask to Monad network (chain ID 143)');
    }

    const contract = new ethers.Contract(REP_REGISTRY, ABI, signer);

    showStatus('pending pulsing', 'Estimating gas...');

    // Estimate gas first
    let gasEstimate;
    try {
      gasEstimate = await contract.giveFeedback.estimateGas(
        AGENT_ID, value, 0, selectedTag, tag2, ENDPOINT, comment, ethers.ZeroHash
      );
    } catch (estErr) {
      const msg = estErr.reason || estErr.shortMessage || estErr.message || '';
      if (msg.toLowerCase().includes('self-feedback') || msg.toLowerCase().includes('self')) {
        throw new Error('Self-feedback not allowed. You cannot rate an agent you own.');
      }
      if (msg.toLowerCase().includes('cooldown')) {
        throw new Error('Cooldown active. Please wait before submitting another review.');
      }
      throw new Error('Transaction would revert: ' + msg.slice(0, 120));
    }

    showStatus('pending pulsing', 'Confirm in MetaMask...');

    const tx = await contract.giveFeedback(
      AGENT_ID, value, 0, selectedTag, tag2, ENDPOINT, comment, ethers.ZeroHash,
      { gasLimit: gasEstimate * 2n }
    );

    showStatus('pending pulsing', 'Transaction sent. Waiting for confirmation...<br><a href="https://monadscan.com/tx/' + tx.hash + '" target="_blank" rel="noopener">' + tx.hash.slice(0, 16) + '...</a>');

    await tx.wait();

    showStatus('success', 'Feedback submitted! Your on-chain review is live.<br><a href="https://monadscan.com/tx/' + tx.hash + '" target="_blank" rel="noopener">View on Monadscan &#8599;</a>');

    btn.innerHTML = '<span>Submitted</span>';
  } catch (err) {
    console.error(err);
    let msg = err.reason || err.shortMessage || err.message || 'Transaction failed';
    if (msg.includes('user rejected')) msg = 'Transaction cancelled by user.';
    if (msg.includes('insufficient funds')) msg = 'Insufficient MON for gas. Get MON at monad.xyz';
    showStatus('error', msg);
    btn.disabled = false;
    btn.innerHTML = '<span>Submit On-Chain Feedback</span>';
  }
}

function showStatus(cls, html) {
  const box = document.getElementById('statusBox');
  box.className = 'status show ' + cls;
  box.innerHTML = html;
}

function hideStatus() {
  document.getElementById('statusBox').className = 'status';
}
</script>

</body>
</html>
